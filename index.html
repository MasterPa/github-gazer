<!DOCTYPE html>
<html lang='en-US'>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' href='https://pingao777.github.io/github-gazer/assets/css/style.css?v=83f9436b2e1b1a48c5227dc3037dbc5f1a9b5db1'>
    <!-- Begin Jekyll SEO tag v2.5.0 -->
    <title>Welcome to GitHub Pages | github-gazer</title>
    <meta name='generator' content='Jekyll v3.7.3.1'/>
    <meta property='og:title' content='Welcome to GitHub Pages'/>
    <meta property='og:locale' content='en_US'/>
    <link rel='canonical' href='https://pingao777.github.io/github-gazer/'/>
    <meta property='og:url' content='https://pingao777.github.io/github-gazer/'/>
    <meta property='og:site_name' content='github-gazer'/>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/echarts/4.1.0/echarts.min.js'></script>
    <script type='application/ld+json'>
{'@type':'WebSite','headline':'Welcome to GitHub Pages','url':'https://pingao777.github.io/github-gazer/','name':'github-gazer','@context':'http://schema.org'}


    </script>
    <!-- End Jekyll SEO tag -->
</head>
<body>
<a href='https://github.com/pingao777/github-gazer'><img style='position: absolute; top: 0; right: 0; border: 0;' src='https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png' alt='Fork me on GitHub'></a>
<div class='container'>
    <section id='main_content'>
        <div id='star-chart' style='width: 100%;height:400px; margin-top: 20px;'></div>
    </section>
    <script type='text/javascript'>
        var display_star_chart = function (repo, data) {
            var myChart = echarts.init(document.getElementById('star-chart'), 'dark');

            var option = {
                backgroundColor: 'rgba(0,0,0,0.0)',

                title: {
                    text: 'Stargazers Trend  (' + repo + ')',
                    left: '10%',  // 不要用right，否则副标题不显示
                    top: '5%'  // 不要用bottom，否则副标题不显示
                },
                tooltip: {},
                grid: {},
                xAxis: {
                    type: 'time',
                    axisLine: {onZero: false},
                    axisLabel: {
                        formatter: function (value, index) {
                            // 格式化成月/日，只在第一个刻度显示年份
                            var date = new Date(value);
                            var texts = [date.getFullYear(), (date.getMonth() + 1), date.getDate()];
                            return texts.join('/');
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {onZero: false}
                },
                dataZoom: [
                    {
                        type: 'slider',
                        xAxisIndex: 0,
                        filterMode: 'empty'
                    },
                    {
                        type: 'inside',
                        xAxisIndex: 0,
                        filterMode: 'empty'
                    }
                ],
                series: [
                    {
                        id: 'a',
                        type: 'line',
//                            smooth: true,
                        symbolSize: 0,
                        data: data,
                        color: 'rgba(40,167,69,1.0)',
                        tooltip: {
                            formatter: function (params) {
                                var date = new Date(params.value[0]);
                                return ' （'
                                    + date.getFullYear() + '-'
                                    + (date.getMonth() + 1) + '-'
                                    + date.getDate() + ' '
                                    + date.getHours() + ':'
                                    + date.getMinutes()
                                    + '）<br/>'
                                    + params.value[1];
                            }
                        }
                    }
                ]
            };


            // 使用刚指定的配置项和数据显示图表。
            myChart.setOption(option);
        };

        var parse_query = function (query_string) {

            if (is_empty(query_string)) {
                return {};
            }
            var query = {};
            query_string = query_string.charAt(0) === '?' ? query_string.substring(1) : query_string;
            console.log(query_string);
            var query_array = query_string.split('&');
            for (var i in query_array) {
                var kv = query_array[i].split('=');
                console.log(kv);
                query[kv[0]] = kv[1];
            }
            return query;

        };

        var is_empty = function (s) {
            return s === null || s === undefined || s === '';
        };


        var query = parse_query(window.location.search);
        var repo = is_empty(query['repo']) ? 'pingao777/markdown-preview-sync' : query['repo'];
        var access_token = is_empty(query['access_token']) ? '' : query['access_token'];


        var get_one_page_stargazers = function (repo, page) {
            var stargazers = [];

            $.ajax({
                headers: {
                    Accept: 'application/vnd.github.v3.star+json; charset=utf-8'
                },
                url: 'https://api.github.com/repos/' + repo + '/stargazers?per_page=100&page=' + page
                + (is_empty(access_token) ? '' : '&access_token=' + access_token),
                dataType: 'json',
                type: 'get',
                async: false,
                success: function (data) {
                    if (data.length !== 0) {
                        stargazers = data.map(function (e, i) {
                            return [e.starred_at.replace('T', ' ').replace('Z', ''), i + 1 + page * 100]
                        });
                    }
                }
            });

            return stargazers;
        };

        var get_all_stargazers = function (repo) {

            var stargazers = [];

            var page = 1;
            var stargazers_page = get_one_page_stargazers(repo, page);

            while (stargazers_page.length !== 0) {
                stargazers = stargazers.concat(stargazers_page);
                page++;
                stargazers_page = get_one_page_stargazers(repo, page);
            }

            return stargazers;
        };


        //        var stargazers = [1, 2];
        var stargazers = get_all_stargazers(repo);
        display_star_chart(repo, stargazers);
    </script>
</div>
</body>
</html>
